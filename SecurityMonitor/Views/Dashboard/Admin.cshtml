@{
    ViewData["Title"] = "Dashboard quản trị";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-shield-lock"></i> Quản trị hệ thống</h2>
        <div class="btn-group">
            <button class="btn btn-outline-primary" id="refreshDashboard">
                <i class="bi bi-arrow-clockwise"></i> Làm mới
            </button>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="bi bi-gear"></i> Cài đặt
            </button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Tổng số người dùng</h6>
                            <h2 class="card-title mb-0" id="totalUsers">128</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-white-50">
                            <span class="badge bg-light text-primary">Admin: 5</span>
                            <span class="badge bg-light text-primary">Analyst: 23</span>
                            <span class="badge bg-light text-primary">User: 100</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Lượt đăng nhập hôm nay</h6>
                            <h2 class="card-title mb-0" id="todayLogins">42</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-box-arrow-in-right"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-white-50">
                            <i class="bi bi-arrow-up"></i> Tăng 15% so với hôm qua
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card bg-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Nguồn log đang hoạt động</h6>
                            <h2 class="card-title mb-0" id="activeSources">15</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-hdd-network"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-dark">
                            <span class="badge bg-light text-warning">3 Server</span>
                            <span class="badge bg-light text-warning">12 Client</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Cảnh báo chưa xử lý</h6>
                            <h2 class="card-title mb-0" id="activeAlerts">7</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-white-50">
                            <span class="badge bg-light text-danger">2 Critical</span>
                            <span class="badge bg-light text-danger">5 High</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-activity"></i> Hoạt động hệ thống</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary active">24h</button>
                            <button class="btn btn-sm btn-outline-secondary">7 ngày</button>
                            <button class="btn btn-sm btn-outline-secondary">30 ngày</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="systemActivityChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Phân bố cảnh báo</h5>
                </div>
                <div class="card-body">
                    <canvas id="alertDistributionChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> Nhật ký hoạt động gần đây</h5>
                <button class="btn btn-sm btn-outline-primary" id="exportLogs">
                    <i class="bi bi-download"></i> Xuất báo cáo
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="auditLogTable" class="table table-hover">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Hành động</th>
                            <th>Người thực hiện</th>
                            <th>IP</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2025-07-18 11:02</td>
                            <td><span class="badge bg-info">Thêm người dùng</span></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="~/images/avatar-placeholder.png" class="rounded-circle me-2" width="24">
                                    admin01
                                </div>
                            </td>
                            <td><code>192.168.1.10</code></td>
                            <td><span class="badge bg-success">Thành công</span></td>
                        </tr>
                        <tr>
                            <td>2025-07-18 10:45</td>
                            <td><span class="badge bg-warning">Xóa cảnh báo</span></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="~/images/avatar-placeholder.png" class="rounded-circle me-2" width="24">
                                    admin01
                                </div>
                            </td>
                            <td><code>192.168.1.10</code></td>
                            <td><span class="badge bg-success">Thành công</span></td>
                        </tr>
                        <tr>
                            <td>2025-07-18 09:30</td>
                            <td><span class="badge bg-primary">Phân quyền</span></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="~/images/avatar-placeholder.png" class="rounded-circle me-2" width="24">
                                    admin02
                                </div>
                            </td>
                            <td><code>192.168.1.15</code></td>
                            <td><span class="badge bg-success">Thành công</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cài đặt Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Tự động làm mới</label>
                    <select class="form-select">
                        <option value="0">Tắt</option>
                        <option value="30">30 giây</option>
                        <option value="60">1 phút</option>
                        <option value="300">5 phút</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Hiển thị thông báo</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showCriticalAlerts" checked>
                        <label class="form-check-label" for="showCriticalAlerts">
                            Cảnh báo nghiêm trọng
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showSystemNotifications" checked>
                        <label class="form-check-label" for="showSystemNotifications">
                            Thông báo hệ thống
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize DataTable
        $(document).ready(function() {
            $('#auditLogTable').DataTable({
                order: [[0, 'desc']],
                pageLength: 10,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                }
            });

            // System Activity Chart
            const activityCtx = document.getElementById('systemActivityChart').getContext('2d');
            new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
                    datasets: [{
                        label: 'Đăng nhập',
                        data: [12, 19, 3, 5, 2, 3, 15, 8],
                        borderColor: '#0d6efd',
                        tension: 0.4
                    }, {
                        label: 'Cảnh báo',
                        data: [5, 15, 8, 12, 3, 7, 4, 6],
                        borderColor: '#dc3545',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Alert Distribution Chart
            const alertCtx = document.getElementById('alertDistributionChart').getContext('2d');
            new Chart(alertCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [2, 5, 8, 12],
                        backgroundColor: ['#6610f2', '#dc3545', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Initialize SignalR connection for real-time updates
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/alertHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on("ReceiveAlert", (alert) => {
                // Update alerts count and notification
                const alertCount = parseInt($('#activeAlerts').text());
                $('#activeAlerts').text(alertCount + 1);
                
                if (alert.severity === 'Critical') {
                    toastr.error(`Cảnh báo mới: ${alert.message}`, 'Cảnh báo nghiêm trọng');
                }
            });

            connection.start().catch(err => console.error(err));
        });

        // Refresh Dashboard
        $('#refreshDashboard').click(function() {
            location.reload();
        });

        // Export Logs
        $('#exportLogs').click(function() {
            // Add export functionality
        });
    </script>
}
