@model List<SecurityMonitor.DTOs.UserManagementDto>
@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Danh sách người dùng</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="usersTable">
                    <thead>
                        <tr>
                            <th>Tên đăng nhập</th>
                            <th>Email</th>
                            <th>Vai trò</th>
                            <th>Trạng thái</th>
                            <th>Lần đăng nhập cuối</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            <tr>
                                <td>@user.UserName</td>
                                <td>@user.Email</td>
                                <td>@string.Join(", ", user.Roles)</td>
                                <td>
                                    @if (user.IsLocked)
                                    {
                                        <span class="badge bg-danger">Đã khóa</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Hoạt động</span>
                                    }
                                </td>
                                <td>
                                    @(user.LastLoginTime?.ToString("dd/MM/yyyy HH:mm:ss") ?? "Chưa đăng nhập")
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                            Thao tác
                                        </button>
                                        <ul class="dropdown-menu">
                                            @if (!user.Roles.Contains("Admin"))
                                            {
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="showRestrictionModal('@user.UserName')">
                                                        <i class="fas fa-ban"></i> Hạn chế tài khoản
                                                    </a>
                                                </li>
                                                if (!user.IsLocked)
                                                {
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="showLockModal('@user.UserName')">
                                                            <i class="fas fa-lock"></i> Khóa tài khoản
                                                        </a>
                                                    </li>
                                                }
                                                else
                                                {
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="unlockUser('@user.UserName')">
                                                            <i class="fas fa-lock-open"></i> Mở khóa
                                                        </a>
                                                    </li>
                                                }
                                                <li><hr class="dropdown-divider"></li>
                                            }
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="showRoleModal('@user.UserName', '@string.Join(",", user.Roles)')">
                                                    <i class="fas fa-user-tag"></i> Đổi vai trò
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Khóa tài khoản -->
<div class="modal fade" id="lockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Khóa tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="lockUserName" />
                <div class="mb-3">
                    <label class="form-label">Thời gian khóa (ngày)</label>
                    <input type="number" class="form-control" id="lockDays" min="1" value="1" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Lý do khóa</label>
                    <textarea class="form-control" id="lockReason" rows="3"></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="disableLogin">
                    <label class="form-check-label">
                        Vô hiệu hóa đăng nhập
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="lockUser()">Khóa tài khoản</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Hạn chế tài khoản -->
<div class="modal fade" id="restrictionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hạn chế tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="restrictUserName" />
                <div class="mb-3">
                    <label class="form-label">Loại hạn chế</label>
                    <select class="form-select" id="restrictionType">
                        <option value="ReadOnly">Chỉ đọc</option>
                        <option value="Temporary">Tạm thời</option>
                        <option value="Disable">Vô hiệu hóa</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Lý do</label>
                    <textarea class="form-control" id="restrictionReason" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Thời gian kết thúc</label>
                    <input type="datetime-local" class="form-control" id="restrictionEndTime" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi chú bổ sung</label>
                    <textarea class="form-control" id="restrictionNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="restrictUser()">Áp dụng hạn chế</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Đổi vai trò -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đổi vai trò</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="roleUserName" />
                <div class="mb-3">
                    <label class="form-label">Chọn vai trò</label>
                    <select class="form-select" id="userRole">
                        <option value="User">User</option>
                        <option value="Analyst">Analyst</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateRole()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Hiển thị modal khóa tài khoản
        function showLockModal(userName) {
            document.getElementById('lockUserName').value = userName;
            new bootstrap.Modal(document.getElementById('lockModal')).show();
        }

        // Hiển thị modal hạn chế tài khoản
        function showRestrictionModal(userName) {
            document.getElementById('restrictUserName').value = userName;
            new bootstrap.Modal(document.getElementById('restrictionModal')).show();
        }

        // Hiển thị modal đổi vai trò
        function showRoleModal(userName, currentRoles) {
            document.getElementById('roleUserName').value = userName;
            document.getElementById('userRole').value = currentRoles.split(',')[0];
            new bootstrap.Modal(document.getElementById('roleModal')).show();
        }

        // Khóa tài khoản
        function lockUser() {
            const userName = document.getElementById('lockUserName').value;
            const days = document.getElementById('lockDays').value;
            const reason = document.getElementById('lockReason').value;
            const disableLogin = document.getElementById('disableLogin').checked;

            if (!reason) {
                alert('Vui lòng nhập lý do khóa tài khoản');
                return;
            }

            fetch('/AccountManagement/LockUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userName: userName,
                    days: days,
                    reason: reason,
                    disableLogin: disableLogin
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        // Mở khóa tài khoản
        function unlockUser(userName) {
            if (!confirm('Bạn có chắc muốn mở khóa tài khoản này?')) {
                return;
            }

            fetch('/AccountManagement/UnlockUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userName: userName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        // Hạn chế tài khoản
        function restrictUser() {
            const userName = document.getElementById('restrictUserName').value;
            const type = document.getElementById('restrictionType').value;
            const reason = document.getElementById('restrictionReason').value;
            const endTime = document.getElementById('restrictionEndTime').value;
            const notes = document.getElementById('restrictionNotes').value;

            if (!reason) {
                alert('Vui lòng nhập lý do hạn chế tài khoản');
                return;
            }

            fetch('/AccountManagement/RestrictUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userName: userName,
                    restrictionType: type,
                    reason: reason,
                    endTime: endTime,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        // Cập nhật vai trò
        function updateRole() {
            const userName = document.getElementById('roleUserName').value;
            const role = document.getElementById('userRole').value;

            fetch('/AccountManagement/UpdateRole', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userName: userName,
                    role: role
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }
    </script>
}
