@model IEnumerable<SecurityMonitor.Models.LogEntry>
@{
    ViewData["Title"] = "Qu·∫£n L√Ω Logs";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-file-alt text-primary"></i>
            Qu·∫£n L√Ω Logs
        </h1>
        <div class="d-flex align-items-center">

            <button class="btn btn-primary me-2" onclick="generateTestLog()">
                <i class="fas fa-plus"></i> T·∫°o Test Log
            </button>
            <button class="btn btn-warning me-2" onclick="generateBulkLogs()">
                <i class="fas fa-layer-group"></i> Sinh Nhi·ªÅu Logs
            </button>
            <button class="btn btn-danger" onclick="clearAllLogs()">
                <i class="fas fa-trash"></i> X√≥a T·∫•t C·∫£
            </button>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> Danh S√°ch Logs
            </h6>
            <div class="d-flex">
                <input type="text" class="form-control me-2" id="searchInput" placeholder="T√¨m ki·∫øm logs...">
                <select class="form-control me-2" id="levelFilter">
                    <option value="">T·∫•t c·∫£ levels</option>
                    <option value="1">Info</option>
                    <option value="2">Warning</option>
                    <option value="3">Error</option>
                </select>
                <select class="form-control me-2" id="sourceFilter">
                    <option value="">T·∫•t c·∫£ sources</option>
                    <option value="1">System</option>
                    <option value="2">Network</option>
                    <option value="3">Application</option>
                    <option value="4">Database</option>
                    <option value="5">Security</option>
                </select>
                <select class="form-control" id="pageSizeSelect" onchange="changePageSize(this.value)">
                    <option value="10" selected="@(ViewBag.PageSize == 10)">10/trang</option>
                    <option value="20" selected="@(ViewBag.PageSize == 20)">20/trang</option>
                    <option value="50" selected="@(ViewBag.PageSize == 50)">50/trang</option>
                    <option value="100" selected="@(ViewBag.PageSize == 100)">100/trang</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="logsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Th·ªùi Gian</th>
                            <th>Level</th>
                            <th>Source</th>
                            <th>IP Address</th>
                            <th>User</th>
                            <th>Message</th>
                            <th>Status</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model)
                        {
                            <tr data-log-id="@log.Id">
                                <td>@log.Id</td>
                                <td>@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>
                                    <span class="badge @(log.LogLevelTypeId == 1 ? "bg-info" : log.LogLevelTypeId == 2 ? "bg-warning" : "bg-danger")">
                                        @(log.LogLevelTypeId == 1 ? "Info" : log.LogLevelTypeId == 2 ? "Warning" : "Error")
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        @(log.LogSourceId == 1 ? "System" : log.LogSourceId == 2 ? "Network" : log.LogSourceId == 3 ? "Application" : log.LogSourceId == 4 ? "Database" : "Security")
                                    </span>
                                </td>
                                <td>@log.IpAddress</td>
                                <td>@log.UserId</td>
                                <td>@log.Message</td>
                                <td>
                                    <span class="badge @(log.WasSuccessful ? "bg-success" : "bg-danger")">
                                        @(log.WasSuccessful ? "Success" : "Failed")
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="createAlertFromLog(@log.Id)" title="T·∫°o c·∫£nh b√°o">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteLog(@log.Id)" title="X√≥a log">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        Hi·ªÉn th·ªã @(((ViewBag.CurrentPage - 1) * ViewBag.PageSize) + 1) - 
                        @Math.Min(ViewBag.CurrentPage * ViewBag.PageSize, ViewBag.TotalCount) 
                        c·ªßa @ViewBag.TotalCount logs
                    </div>
                    <nav aria-label="Logs pagination">
                        <ul class="pagination mb-0">
                            @if (ViewBag.CurrentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Logs", new { page = ViewBag.CurrentPage - 1, pageSize = ViewBag.PageSize })">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            }

                            @{
                                var startPage = Math.Max(1, ViewBag.CurrentPage - 2);
                                var endPage = Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2);
                            }

                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Logs", new { page = 1, pageSize = ViewBag.PageSize })">1</a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Logs", new { page = i, pageSize = ViewBag.PageSize })">@i</a>
                                </li>
                            }

                            @if (endPage < ViewBag.TotalPages)
                            {
                                @if (endPage < ViewBag.TotalPages - 1)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Logs", new { page = ViewBag.TotalPages, pageSize = ViewBag.PageSize })">@ViewBag.TotalPages</a>
                                </li>
                            }

                            @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Logs", new { page = ViewBag.CurrentPage + 1, pageSize = ViewBag.PageSize })">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        let alertHub, logHub;

        $(document).ready(function() {
            setupSignalR();
            setupLogFilters();
        });

        function setupSignalR() {
            // Alert Hub
            alertHub = new signalR.HubConnectionBuilder()
                .withUrl("/alertHub")
                .build();

            alertHub.start().then(function() {
                console.log("AlertHub connected");
                alertHub.invoke("JoinAlertGroup");
            }).catch(function(err) {
                console.error("AlertHub connection error: ", err);
            });

            alertHub.on("ReceiveNewAlert", function(alert) {
                showNewAlertNotification(alert);
            });

            // Log Hub
            logHub = new signalR.HubConnectionBuilder()
                .withUrl("/logHub")
                .build();

            logHub.start().then(function() {
                console.log("LogHub connected");
                logHub.invoke("JoinLogGroup");
            }).catch(function(err) {
                console.error("LogHub connection error: ", err);
            });

            // X√≥a duplicate event listeners - ch·ªâ d√πng logConnection
            // logHub.on("ReceiveNewLog", function(log) {
            //     addNewLogToTable(log);
            // });

            // logHub.on("ReceiveLogUpdate", function(logId, action) {
            //     handleLogUpdate(logId, action);
            // });
        }



        function setupLogFilters() {
            $('#searchInput, #levelFilter, #sourceFilter').on('change keyup', function() {
                filterLogs();
            });
        }

        function filterLogs() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const levelFilter = $('#levelFilter').val();
            const sourceFilter = $('#sourceFilter').val();

            $('#logsTable tbody tr').each(function() {
                const row = $(this);
                const message = row.find('td:eq(6)').text().toLowerCase();
                const level = row.find('td:eq(2) .badge').text();
                const source = row.find('td:eq(3) .badge').text();

                let show = true;

                // Search filter
                if (searchTerm && !message.includes(searchTerm)) {
                    show = false;
                }

                // Level filter
                if (levelFilter) {
                    const levelValue = level === 'Info' ? '1' : level === 'Warning' ? '2' : '3';
                    if (levelValue !== levelFilter) {
                        show = false;
                    }
                }

                // Source filter
                if (sourceFilter) {
                    const sourceValue = source === 'System' ? '1' : source === 'Network' ? '2' : source === 'Application' ? '3' : source === 'Database' ? '4' : '5';
                    if (sourceValue !== sourceFilter) {
                        show = false;
                    }
                }

                row.toggle(show);
            });
        }



        function generateTestLog() {
            $.post('/api/admin/generateTestLog')
                .done(function() {
                    toastr.success('Test log generated successfully');
                    // Kh√¥ng reload trang, logs s·∫Ω ƒë∆∞·ª£c th√™m real-time
                })
                .fail(function() {
                    toastr.error('Failed to generate test log');
                });
        }

        function generateBulkLogs() {
            $.post('/api/admin/generateBulkLogs')
                .done(function() {
                    toastr.success('Bulk logs generated successfully');
                    // Kh√¥ng reload trang, logs s·∫Ω ƒë∆∞·ª£c th√™m real-time
                })
                .fail(function() {
                    toastr.error('Failed to generate bulk logs');
                });
        }

        function clearAllLogs() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ logs?')) {
                $.post('/api/admin/clearAllLogs')
                    .done(function() {
                        toastr.success('All logs cleared successfully');
                        // X√≥a t·∫•t c·∫£ rows trong b·∫£ng
                        $('#logsTable tbody').empty();
                        updateLogCount();
                    })
                    .fail(function() {
                        toastr.error('Failed to clear logs');
                    });
            }
        }

        function deleteLog(logId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a log n√†y?')) {
                $.ajax({
                    url: `/api/logs/${logId}`,
                    type: 'DELETE',
                    success: function() {
                        toastr.success('Log deleted successfully');
                        $(`tr[data-log-id="${logId}"]`).remove();
                    },
                    error: function() {
                        toastr.error('Failed to delete log');
                    }
                });
            }
        }

        function createAlertFromLog(logId) {
            $.post(`/api/admin/createAlertFromLog/${logId}`)
                .done(function() {
                    toastr.success('Alert created from log successfully');
                })
                .fail(function() {
                    toastr.error('Failed to create alert from log');
                });
        }

        function showNewAlertNotification(alert) {
            toastr.warning(`üö® C·∫£nh b√°o m·ªõi: ${alert.title}`, {
                timeOut: 0,
                extendedTimeOut: 0,
                closeButton: true,
                progressBar: true
            });
        }

        function changePageSize(pageSize) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('pageSize', pageSize);
            currentUrl.searchParams.set('page', '1'); // Reset v·ªÅ trang ƒë·∫ßu
            window.location.href = currentUrl.toString();
        }

        // Track processed log IDs to avoid duplicates
        let processedLogIds = new Set();
        
        function addNewLogToTable(log) {
            // Ki·ªÉm tra xem log n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ch∆∞a
            if (processedLogIds.has(log.id)) {
                console.log(`‚ö†Ô∏è Log ID ${log.id} ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω, b·ªè qua`);
                return;
            }
            
            // Th√™m ID v√†o set ƒë√£ x·ª≠ l√Ω
            processedLogIds.add(log.id);
            
            // Gi·ªõi h·∫°n set ƒë·ªÉ tr√°nh memory leak (gi·ªØ 1000 IDs g·∫ßn nh·∫•t)
            if (processedLogIds.size > 1000) {
                const firstKey = processedLogIds.values().next().value;
                processedLogIds.delete(firstKey);
            }
            
            // T·∫°o row m·ªõi cho log
            const newRow = `
                <tr data-log-id="${log.id}" class="new-log-row">
                    <td>${log.id}</td>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>
                        <span class="badge ${log.logLevelTypeId == 1 ? 'bg-info' : log.logLevelTypeId == 2 ? 'bg-warning' : 'bg-danger'}">
                            ${log.logLevelTypeId == 1 ? 'Info' : log.logLevelTypeId == 2 ? 'Warning' : 'Error'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-secondary">
                            ${log.logSourceId == 1 ? 'System' : log.logSourceId == 2 ? 'Network' : log.logSourceId == 3 ? 'Application' : log.logSourceId == 4 ? 'Database' : 'Security'}
                        </span>
                    </td>
                    <td>${log.ipAddress}</td>
                    <td>${log.userId}</td>
                    <td>${log.message}</td>
                    <td>
                        <span class="badge ${log.wasSuccessful ? 'bg-success' : 'bg-danger'}">
                            ${log.wasSuccessful ? 'Success' : 'Failed'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="createAlertFromLog(${log.id})" title="T·∫°o c·∫£nh b√°o">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLog(${log.id})" title="X√≥a log">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            // Th√™m v√†o ƒë·∫ßu b·∫£ng
            $('#logsTable tbody').prepend(newRow);
            
            // Highlight row m·ªõi
            $('.new-log-row').addClass('table-success');
            setTimeout(() => {
                $('.new-log-row').removeClass('table-success new-log-row');
            }, 3000);
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng logs
            updateLogCount();
            
            console.log(`‚úÖ ƒê√£ th√™m log m·ªõi: ID ${log.id}`);
        }

        function handleLogUpdate(logId, action) {
            const row = $(`tr[data-log-id="${logId}"]`);
            
            if (action === 'deleted') {
                row.fadeOut(500, function() {
                    $(this).remove();
                    updateLogCount();
                });
                toastr.warning('üóëÔ∏è Log ƒë√£ ƒë∆∞·ª£c x√≥a');
            } else if (action === 'updated') {
                row.addClass('table-warning');
                setTimeout(() => {
                    row.removeClass('table-warning');
                }, 2000);
                toastr.info('‚úèÔ∏è Log ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t');
            }
        }

        function updateLogCount() {
            const count = $('#logsTable tbody tr').length;
            console.log(`üìä T·ªïng s·ªë logs: ${count}`);
        }

        // SignalR connection cho logs real-time
        let logConnection;
        
        function initializeLogConnection() {
            logConnection = new signalR.HubConnectionBuilder()
                .withUrl("/logHub")
                .withAutomaticReconnect()
                .build();

            logConnection.on("ReceiveNewLog", function(log) {
                console.log("üìù Nh·∫≠n log m·ªõi:", log);
                addNewLogToTable(log);
            });

            logConnection.on("ReceiveLogUpdate", function(logId, action) {
                console.log("üìù C·∫≠p nh·∫≠t log:", logId, action);
                handleLogUpdate(logId, action);
            });

            logConnection.start()
                .then(function() {
                    console.log("‚úÖ K·∫øt n·ªëi LogHub th√†nh c√¥ng");
                    logConnection.invoke("JoinLogGroup");
                })
                .catch(function(err) {
                    console.error("‚ùå L·ªói k·∫øt n·ªëi LogHub:", err);
                });
        }

        function updateLogInTable(log) {
            const row = $(`tr[data-log-id="${log.id}"]`);
            if (row.length > 0) {
                row.find('td:eq(1)').text(new Date(log.timestamp).toLocaleString());
                row.find('td:eq(2) span').text(log.logLevelTypeId == 1 ? 'Info' : log.logLevelTypeId == 2 ? 'Warning' : 'Error');
                row.find('td:eq(3) span').text(log.logSourceId == 1 ? 'System' : log.logSourceId == 2 ? 'Network' : log.logSourceId == 3 ? 'Application' : log.logSourceId == 4 ? 'Database' : 'Security');
                row.find('td:eq(4)').text(log.ipAddress);
                row.find('td:eq(5)').text(log.userId);
                row.find('td:eq(6)').text(log.message);
                row.find('td:eq(7) span').text(log.wasSuccessful ? 'Success' : 'Failed');
            }
        }

        // Kh·ªüi t·∫°o SignalR connection khi trang load
        $(document).ready(function() {
            initializeLogConnection();
        });

    </script>
} 