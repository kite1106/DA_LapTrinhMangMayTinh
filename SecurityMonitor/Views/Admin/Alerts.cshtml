@model IEnumerable<SecurityMonitor.Models.Alert>
@{
    ViewData["Title"] = "Qu·∫£n L√Ω C·∫£nh B√°o";
    Layout = "_AdminLayout";
}

<style>
    .new-alert {
        animation: highlightNew 3s ease-in-out;
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    @@keyframes highlightNew {
        0% { background-color: #fff3cd; transform: translateX(-10px); }
        50% { background-color: #fff3cd; transform: translateX(0); }
        100% { background-color: transparent; transform: translateX(0); }
    }

    .alert-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .alert-badge.suspiciousip { background-color: #e3f2fd; color: #1976d2; }
    .alert-badge.ddos { background-color: #ffebee; color: #d32f2f; }
    .alert-badge.bruteforce { background-color: #fff3e0; color: #f57c00; }
    .alert-badge.sqlinjection { background-color: #f3e5f5; color: #7b1fa2; }
    .alert-badge.malware { background-color: #e8f5e8; color: #388e3c; }
    .alert-badge.unknown { background-color: #f5f5f5; color: #616161; }

    .alert-badge.critical { background-color: #ffebee; color: #d32f2f; }
    .alert-badge.high { background-color: #fff3e0; color: #f57c00; }
    .alert-badge.medium { background-color: #fff8e1; color: #f57c00; }
    .alert-badge.low { background-color: #e8f5e8; color: #388e3c; }

    /* Process Alert Modal Styles */
    .process-action-option {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }

    .process-action-option:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }

    .process-action-option input[type="radio"]:checked + label {
        color: #007bff;
        font-weight: 600;
    }

    .process-action-option input[type="radio"]:checked ~ .process-action-option {
        border-color: #007bff;
        background-color: #e3f2fd;
    }

    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }

    .form-check-label {
        cursor: pointer;
        user-select: none;
    }

    .form-check-label i {
        width: 20px;
        text-align: center;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 2px solid transparent;
        color: #6c757d;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        border-bottom: 2px solid #007bff;
        color: #007bff;
        background: none;
    }

    .tab-content {
        padding-top: 1rem;
    }

    /* Hi·ªáu ·ª©ng highlight cho c·∫£nh b√°o m·ªõi */
    .new-alert-highlight {
        animation: highlightNewAlert 5s ease-in-out;
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.3) !important;
    }

    @@keyframes highlightNewAlert {
        0% { 
            background-color: #fff3cd; 
            transform: translateX(-10px); 
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
        }
        50% { 
            background-color: #fff3cd; 
            transform: translateX(0); 
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
        }
        100% { 
            background-color: transparent; 
            transform: translateX(0); 
            box-shadow: none;
        }
    }

    /* Hi·ªáu ·ª©ng nh·∫•p nh√°y cho trang */
    .page-flash {
        animation: pageFlash 1s ease-in-out;
    }

    @@keyframes pageFlash {
        0% { 
            background-color: rgba(255, 193, 7, 0.1); 
        }
        50% { 
            background-color: rgba(255, 193, 7, 0.2); 
        }
        100% { 
            background-color: transparent; 
        }
    }

    /* Hi·ªáu ·ª©ng pulse cho tab c·∫£nh b√°o */
    .alert-tab-pulse {
        animation: tabPulse 2s ease-in-out infinite;
    }

    @@keyframes tabPulse {
        0% { 
            background-color: rgba(255, 193, 7, 0.1); 
        }
        50% { 
            background-color: rgba(255, 193, 7, 0.3); 
        }
        100% { 
            background-color: transparent; 
        }
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Qu·∫£n L√Ω C·∫£nh B√°o
                    </h5>
                    <div>
                        <button class="btn btn-modern btn-info" onclick="refreshAlerts()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="alertsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                C·∫£nh B√°o Ho·∫°t ƒê·ªông
                                <span class="badge bg-warning ms-2" id="activeCount">@Model.Count(a => a.Status?.Name != "Resolved")</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resolved-tab" data-bs-toggle="tab" data-bs-target="#resolved" type="button" role="tab">
                                <i class="fas fa-check-circle me-2"></i>
                                ƒê√£ X·ª≠ L√Ω
                                <span class="badge bg-success ms-2" id="resolvedCount">@Model.Count(a => a.Status?.Name == "Resolved")</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="alertsTabContent">
                        <!-- Active Alerts Tab -->
                        <div class="tab-pane fade show active" id="active" role="tabpanel">
                            <!-- Filters -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label">Lo·∫°i C·∫£nh B√°o</label>
                                                    <select class="form-select" id="alertTypeFilter">
                                                        <option value="">T·∫•t c·∫£</option>
                                                        <option value="SuspiciousIP">Suspicious IP</option>
                                                        <option value="DDoS">DDoS</option>
                                                        <option value="BruteForce">Brute Force</option>
                                                        <option value="SQLInjection">SQL Injection</option>
                                                        <option value="Malware">Malware</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label">M·ª©c ƒê·ªô</label>
                                                    <select class="form-select" id="severityFilter">
                                                        <option value="">T·∫•t c·∫£</option>
                                                        <option value="Critical">Critical</option>
                                                        <option value="High">High</option>
                                                        <option value="Medium">Medium</option>
                                                        <option value="Low">Low</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label">Tr·∫°ng Th√°i</label>
                                                    <select class="form-select" id="statusFilter">
                                                        <option value="">T·∫•t c·∫£</option>
                                                        <option value="New">M·ªõi</option>
                                                        <option value="InProgress">ƒêang x·ª≠ l√Ω</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label">T√¨m Ki·∫øm</label>
                                                    <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Active Alerts Table -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-list me-2"></i>
                                                Danh S√°ch C·∫£nh B√°o Ho·∫°t ƒê·ªông
                                            </h5>
                                            <span class="badge bg-warning" id="activeAlertsCount">@Model.Count(a => a.Status?.Name != "Resolved") C·∫£nh B√°o</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-modern table-hover" id="activeAlertsTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Th·ªùi Gian</th>
                                                            <th>Lo·∫°i</th>
                                                            <th>M·ª©c ƒê·ªô</th>
                                                            <th>IP Ngu·ªìn</th>
                                                            <th>Ti√™u ƒê·ªÅ</th>
                                                            <th>Tr·∫°ng Th√°i</th>
                                                            <th>Thao T√°c</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="activeAlertsTableBody">
                                                        @foreach (var alert in Model.Where(a => a.Status?.Name != "Resolved"))
                                                        {
                                                            <tr data-alert-id="@alert.Id">
                                                                <td>@alert.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                                                <td>
                                                                    <span class="alert-badge @(alert.AlertType?.Name?.ToLower() ?? "unknown")">
                                                                        @(alert.AlertType?.Name ?? "Unknown")
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span class="alert-badge @(alert.SeverityLevel?.Name?.ToLower() ?? "medium")">
                                                                        @(alert.SeverityLevel?.Name ?? "Medium")
                                                                    </span>
                                                                </td>
                                                                <td><code>@alert.SourceIp</code></td>
                                                                <td>@alert.Title</td>
                                                                <td>
                                                                    <span class="badge bg-@(alert.Status?.Name == "New" ? "warning" : 
                                                                       alert.Status?.Name == "InProgress" ? "info" : "secondary")">
                                                                        @(alert.Status?.Name ?? "Unknown")
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <div class="btn-group btn-group-sm">
                                                                        <button class="btn btn-outline-primary" onclick="viewAlert(@alert.Id)" title="Xem chi ti·∫øt">
                                                                            <i class="fas fa-eye"></i>
                                                                        </button>
                                                                        <button class="btn btn-outline-info" onclick="processAlert(@alert.Id)" title="X·ª≠ l√Ω c·∫£nh b√°o">
                                                                            <i class="fas fa-cogs"></i>
                                                                        </button>
                                                                        <button class="btn btn-outline-success" onclick="resolveAlert(@alert.Id)" title="ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω">
                                                                            <i class="fas fa-check"></i>
                                                                        </button>
                                                                        <button class="btn btn-outline-danger" onclick="deleteAlert(@alert.Id)" title="X√≥a">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resolved Alerts Tab -->
                        <div class="tab-pane fade" id="resolved" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-check-circle me-2"></i>
                                                C·∫£nh B√°o ƒê√£ X·ª≠ L√Ω
                                            </h5>
                                            <span class="badge bg-success" id="resolvedAlertsCount">@Model.Count(a => a.Status?.Name == "Resolved") C·∫£nh B√°o</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-modern table-hover" id="resolvedAlertsTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Th·ªùi Gian</th>
                                                            <th>Lo·∫°i</th>
                                                            <th>M·ª©c ƒê·ªô</th>
                                                            <th>IP Ngu·ªìn</th>
                                                            <th>Ti√™u ƒê·ªÅ</th>
                                                            <th>Ng√†y X·ª≠ L√Ω</th>
                                                            <th>Ng∆∞·ªùi X·ª≠ L√Ω</th>
                                                            <th>Thao T√°c</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="resolvedAlertsTableBody">
                                                        @foreach (var alert in Model.Where(a => a.Status?.Name == "Resolved"))
                                                        {
                                                            <tr data-alert-id="@alert.Id">
                                                                <td>@alert.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                                                <td>
                                                                    <span class="alert-badge @(alert.AlertType?.Name?.ToLower() ?? "unknown")">
                                                                        @(alert.AlertType?.Name ?? "Unknown")
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span class="alert-badge @(alert.SeverityLevel?.Name?.ToLower() ?? "medium")">
                                                                        @(alert.SeverityLevel?.Name ?? "Medium")
                                                                    </span>
                                                                </td>
                                                                <td><code>@alert.SourceIp</code></td>
                                                                <td>@alert.Title</td>
                                                                <td>
                                                                    @if (alert.ResolvedAt.HasValue)
                                                                    {
                                                                        <span class="text-success">@alert.ResolvedAt.Value.ToString("dd/MM/yyyy HH:mm:ss")</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">N/A</span>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    @if (!string.IsNullOrEmpty(alert.ResolvedBy?.UserName))
                                                                    {
                                                                        <span class="text-info">@alert.ResolvedBy.UserName</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">N/A</span>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    <div class="btn-group btn-group-sm">
                                                                        <button class="btn btn-outline-primary" onclick="viewAlert(@alert.Id)" title="Xem chi ti·∫øt">
                                                                            <i class="fas fa-eye"></i>
                                                                        </button>
                                                                        <button class="btn btn-outline-warning" onclick="reopenAlert(@alert.Id)" title="M·ªü l·∫°i">
                                                                            <i class="fas fa-redo"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Detail Modal -->
<div class="modal fade" id="alertDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi Ti·∫øt C·∫£nh B√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertDetailContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="updateAlertStatus()">C·∫≠p Nh·∫≠t</button>
            </div>
        </div>
    </div>
</div>

<!-- Process Alert Modal -->
<div class="modal fade" id="processAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">X·ª≠ L√Ω C·∫£nh B√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Th√¥ng tin c·∫£nh b√°o:</strong>
                    <div id="processAlertInfo"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Ch·ªçn h√†nh ƒë·ªông x·ª≠ l√Ω:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="processAction" id="blockIp" value="blockIp" checked>
                        <label class="form-check-label" for="blockIp">
                            <i class="fas fa-ban text-danger me-2"></i>
                            <strong>Ch·∫∑n IP</strong> - Ch·∫∑n t·∫•t c·∫£ k·∫øt n·ªëi t·ª´ IP n√†y
                        </label>
                    </div>
                    <div class="form-check" id="accountActions" style="display: none;">
                        <input class="form-check-input" type="radio" name="processAction" id="blockAccount" value="blockAccount">
                        <label class="form-check-label" for="blockAccount">
                            <i class="fas fa-user-slash text-danger me-2"></i>
                            <strong>Ch·∫∑n t√†i kho·∫£n</strong> - V√¥ hi·ªáu h√≥a t√†i kho·∫£n li√™n quan
                        </label>
                    </div>
                    <div class="form-check" id="accountActions2" style="display: none;">
                        <input class="form-check-input" type="radio" name="processAction" id="restrictAccount" value="restrictAccount">
                        <label class="form-check-label" for="restrictAccount">
                            <i class="fas fa-user-lock text-warning me-2"></i>
                            <strong>H·∫°n ch·∫ø t√†i kho·∫£n</strong> - Gi·ªõi h·∫°n quy·ªÅn truy c·∫≠p
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="processReason" class="form-label">L√Ω do x·ª≠ l√Ω:</label>
                    <textarea class="form-control" id="processReason" rows="3" placeholder="Nh·∫≠p l√Ω do x·ª≠ l√Ω..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" onclick="executeProcessAction()">
                    <i class="fas fa-cogs me-2"></i>Th·ª±c Hi·ªán
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft-signalr/signalr.min.js"></script>
    <script>
        let currentAlertId = null;
        let alertHub = null;

        $(document).ready(function() {
            setupFilters();
            setupSearch();
            setupSignalR();
            setupTabs();
        });

        function setupTabs() {
            $('#alertsTabs button').on('click', function() {
                updateTabCounts();
            });
        }

        function updateTabCounts() {
            const activeCount = $('#activeAlertsTableBody tr').length;
            const resolvedCount = $('#resolvedAlertsTableBody tr').length;
            
            $('#activeCount').text(activeCount);
            $('#resolvedCount').text(resolvedCount);
            $('#activeAlertsCount').text(activeCount + ' C·∫£nh B√°o');
            $('#resolvedAlertsCount').text(resolvedCount + ' C·∫£nh B√°o');
        }

        function setupSignalR() {
            alertHub = new signalR.HubConnectionBuilder()
                .withUrl("/alertHub")
                .withAutomaticReconnect()
                .build();

            alertHub.on("ReceiveNewAlert", function(alert) {
                addNewAlertToTable(alert);
                updateTabCounts();
                showNewAlertNotification(alert);
            });

            alertHub.on("ReceiveAlertUpdate", function(alert) {
                updateAlertInTable(alert);
            });

            alertHub.on("ReceiveAlertDelete", function(alertId) {
                removeAlertFromTable(alertId);
                updateTabCounts();
            });

            alertHub.start().then(function() {
                console.log("SignalR Connected to AlertHub");
                alertHub.invoke("JoinAlertGroup");
            }).catch(function(err) {
                console.error("SignalR Connection Error: ", err);
            });
        }

        function addNewAlertToTable(alert) {
            const newRow = `
                <tr data-alert-id="${alert.id}" class="new-alert">
                    <td>${formatDateTime(alert.timestamp)}</td>
                    <td>
                        <span class="alert-badge ${alert.alertType?.toLowerCase() || 'unknown'}">
                            ${alert.alertType || 'Unknown'}
                        </span>
                    </td>
                    <td>
                        <span class="alert-badge ${alert.severityLevel?.toLowerCase() || 'medium'}">
                            ${alert.severityLevel || 'Medium'}
                        </span>
                    </td>
                    <td><code>${alert.sourceIp}</code></td>
                    <td>${alert.title}</td>
                    <td>
                        <span class="badge bg-warning">New</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewAlert(${alert.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="processAlert(${alert.id})" title="X·ª≠ l√Ω c·∫£nh b√°o">
                                <i class="fas fa-cogs"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="resolveAlert(${alert.id})" title="ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteAlert(${alert.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            $("#activeAlertsTableBody").prepend(newRow);
            
            setTimeout(() => {
                $(`tr[data-alert-id="${alert.id}"]`).removeClass("new-alert");
            }, 3000);
        }

        function updateAlertInTable(alert) {
            const row = $(`tr[data-alert-id="${alert.id}"]`);
            if (row.length > 0) {
                row.find("td:eq(1) span").text(alert.alertType || 'Unknown');
                row.find("td:eq(2) span").text(alert.severityLevel || 'Medium');
                row.find("td:eq(4)").text(alert.title);
                row.find("td:eq(5) span").text(alert.status || 'Unknown');
            }
        }

        function removeAlertFromTable(alertId) {
            $(`tr[data-alert-id="${alertId}"]`).fadeOut();
        }

        function showNewAlertNotification(alert) {
            // B·ªè th√¥ng b√°o toastr, ch·ªâ highlight v√† nh·∫•p nh√°y trang
            highlightNewAlert(alert);
            flashPage();
        }

        function highlightNewAlert(alert) {
            // Highlight c·∫£nh b√°o m·ªõi
            const alertRow = $(`tr[data-alert-id="${alert.id}"]`);
            if (alertRow.length > 0) {
                alertRow.addClass('new-alert-highlight');
                setTimeout(() => {
                    alertRow.removeClass('new-alert-highlight');
                }, 5000);
            }
        }

        function flashPage() {
            // Hi·ªáu ·ª©ng nh·∫•p nh√°y cho to√†n b·ªô trang
            $('body').addClass('page-flash');
            setTimeout(() => {
                $('body').removeClass('page-flash');
            }, 1000);

            // Hi·ªáu ·ª©ng pulse cho tab c·∫£nh b√°o
            $('#active-tab').addClass('alert-tab-pulse');
            setTimeout(() => {
                $('#active-tab').removeClass('alert-tab-pulse');
            }, 3000);
        }

        function setupFilters() {
            $("#alertTypeFilter, #severityFilter, #statusFilter").change(function() {
                filterAlerts();
            });
        }

        function setupSearch() {
            $("#searchInput").on("input", function() {
                filterAlerts();
            });
        }

        function filterAlerts() {
            const alertType = $("#alertTypeFilter").val();
            const severity = $("#severityFilter").val();
            const status = $("#statusFilter").val();
            const search = $("#searchInput").val().toLowerCase();

            $("#activeAlertsTableBody tr").each(function() {
                const row = $(this);
                const type = row.find("td:eq(1)").text().trim();
                const sev = row.find("td:eq(2)").text().trim();
                const stat = row.find("td:eq(5)").text().trim();
                const title = row.find("td:eq(4)").text().toLowerCase();
                const ip = row.find("td:eq(3)").text().toLowerCase();

                let show = true;

                if (alertType && type !== alertType) show = false;
                if (severity && sev !== severity) show = false;
                if (status && stat !== status) show = false;
                if (search && !title.includes(search) && !ip.includes(search)) show = false;

                row.toggle(show);
            });

            updateTabCounts();
        }

        function refreshAlerts() {
            const button = $("button[onclick='refreshAlerts()']");
            const originalText = button.html();
            
            showLoading(button);
            location.reload();
        }

        function viewAlert(alertId) {
            currentAlertId = alertId;
            
            $.get(`/Alerts/Details/${alertId}`, function(alert) {
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Th√¥ng Tin C∆° B·∫£n</h6>
                            <table class="table table-sm">
                                <tr><td><strong>ID:</strong></td><td>${alert.id}</td></tr>
                                <tr><td><strong>Ti√™u ƒë·ªÅ:</strong></td><td>${alert.title}</td></tr>
                                <tr><td><strong>Lo·∫°i:</strong></td><td>${alert.alertType}</td></tr>
                                <tr><td><strong>M·ª©c ƒë·ªô:</strong></td><td>${alert.severityLevel}</td></tr>
                                <tr><td><strong>IP ngu·ªìn:</strong></td><td><code>${alert.sourceIp}</code></td></tr>
                                <tr><td><strong>Th·ªùi gian:</strong></td><td>${formatDateTime(alert.timestamp)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>M√¥ T·∫£</h6>
                            <p>${alert.description}</p>
                            <h6>Tr·∫°ng Th√°i</h6>
                            <select class="form-select" id="alertStatus">
                                <option value="New" ${alert.status === 'New' ? 'selected' : ''}>M·ªõi</option>
                                <option value="InProgress" ${alert.status === 'InProgress' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                                <option value="Resolved" ${alert.status === 'Resolved' ? 'selected' : ''}>ƒê√£ gi·∫£i quy·∫øt</option>
                                <option value="Closed" ${alert.status === 'Closed' ? 'selected' : ''}>ƒê√£ ƒë√≥ng</option>
                            </select>
                        </div>
                    </div>
                `;
                
                $("#alertDetailContent").html(content);
                $("#alertDetailModal").modal("show");
            }).fail(function() {
                toastr.error('L·ªói khi t·∫£i th√¥ng tin c·∫£nh b√°o');
            });
        }

        function processAlert(alertId) {
            console.log("üîß X·ª≠ l√Ω c·∫£nh b√°o ID:", alertId);
            currentAlertId = alertId;
            
            // Hi·ªÉn th·ªã loading
            $("#processAlertInfo").html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i th√¥ng tin...</div>');
            $('#processAlertModal').modal('show');
            
            $.get(`/api/admin/alertDetails/${alertId}`)
                .done(function(response) {
                    console.log("üì° Response t·ª´ API:", response);
                    const alert = response.alert;
                    const hasAssociatedAccount = response.hasAssociatedAccount;
                    const associatedUser = response.associatedUser;
                    
                    // Hi·ªÉn th·ªã th√¥ng tin c·∫£nh b√°o
                    $("#processAlertInfo").html(`
                        <strong>Ti√™u ƒë·ªÅ:</strong> ${alert.title}<br>
                        <strong>IP ngu·ªìn:</strong> <code>${alert.sourceIp}</code><br>
                        <strong>M·ª©c ƒë·ªô:</strong> ${alert.severityLevel}<br>
                        <strong>Lo·∫°i:</strong> ${alert.alertType}
                        ${hasAssociatedAccount ? `<br><strong>T√†i kho·∫£n li√™n quan:</strong> ${associatedUser}` : ''}
                    `);
                    
                    // Hi·ªÉn th·ªã c√°c t√πy ch·ªçn x·ª≠ l√Ω d·ª±a tr√™n vi·ªác c√≥ t√†i kho·∫£n li√™n quan hay kh√¥ng
                    if (hasAssociatedAccount) {
                        console.log("üë§ C√≥ t√†i kho·∫£n li√™n quan, hi·ªÉn th·ªã t·∫•t c·∫£ t√πy ch·ªçn");
                        // C√≥ t√†i kho·∫£n li√™n quan: hi·ªÉn th·ªã t·∫•t c·∫£ t√πy ch·ªçn
                        $("#accountActions, #accountActions2").show();
                        $("#blockIp").prop('checked', false);
                        $("#blockAccount").prop('checked', true);
                    } else {
                        console.log("üåê Kh√¥ng c√≥ t√†i kho·∫£n li√™n quan, ch·ªâ hi·ªÉn th·ªã Block IP");
                        // Kh√¥ng c√≥ t√†i kho·∫£n li√™n quan: ch·ªâ hi·ªÉn th·ªã Block IP
                        $("#accountActions, #accountActions2").hide();
                        $("#blockIp").prop('checked', true);
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error("‚ùå L·ªói khi t·∫£i th√¥ng tin c·∫£nh b√°o:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);
                    toastr.error('L·ªói khi t·∫£i th√¥ng tin c·∫£nh b√°o: ' + error);
                    $('#processAlertModal').modal('hide');
                });
        }

        function executeProcessAction() {
            const action = $('input[name="processAction"]:checked').val();
            const reason = $("#processReason").val();
            
            console.log("üöÄ Th·ª±c hi·ªán h√†nh ƒë·ªông:", action);
            console.log("üìù L√Ω do:", reason);
            console.log("üÜî Alert ID:", currentAlertId);
            
            if (!reason.trim()) {
                toastr.warning('Vui l√≤ng nh·∫≠p l√Ω do x·ª≠ l√Ω');
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            const button = $('button[onclick="executeProcessAction()"]');
            const originalText = button.html();
            button.html('<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...');
            button.prop('disabled', true);
            
            let apiUrl;
            switch(action) {
                case 'blockIp':
                    apiUrl = `/api/admin/blockIPFromAlert/${currentAlertId}`;
                    break;
                case 'blockAccount':
                    apiUrl = `/api/admin/lockAccountFromAlert/${currentAlertId}`;
                    break;
                case 'restrictAccount':
                    apiUrl = `/api/admin/restrictAccountFromAlert/${currentAlertId}`;
                    break;
                default:
                    toastr.error('H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá');
                    button.html(originalText);
                    button.prop('disabled', false);
                    return;
            }
            
            console.log("üåê G·ªçi API:", apiUrl);
            
            $.ajax({
                url: apiUrl,
                type: 'POST',
                data: JSON.stringify({ reason: reason }),
                contentType: 'application/json',
                success: function(response) {
                    console.log("‚úÖ Response th√†nh c√¥ng:", response);
                    let successMessage;
                    switch(action) {
                        case 'blockIp':
                            successMessage = 'ƒê√£ block IP th√†nh c√¥ng';
                            break;
                        case 'blockAccount':
                            successMessage = 'ƒê√£ kh√≥a t√†i kho·∫£n th√†nh c√¥ng';
                            break;
                        case 'restrictAccount':
                            successMessage = 'ƒê√£ h·∫°n ch·∫ø t√†i kho·∫£n th√†nh c√¥ng';
                            break;
                    }
                    
                    toastr.success(successMessage);
                    $('#processAlertModal').modal('hide');
                    
                    // T·ª± ƒë·ªông resolve alert sau khi x·ª≠ l√Ω
                    resolveAlert(currentAlertId);
                },
                error: function(xhr, status, error) {
                    console.error("‚ùå L·ªói khi x·ª≠ l√Ω c·∫£nh b√°o:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);
                    const errorMessage = xhr.responseJSON?.error || 'L·ªói khi x·ª≠ l√Ω c·∫£nh b√°o';
                    toastr.error(errorMessage);
                    button.html(originalText);
                    button.prop('disabled', false);
                }
            });
        }

        function resolveAlert(alertId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√°nh d·∫•u c·∫£nh b√°o n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω?")) {
                $.ajax({
                    url: `/api/alerts/${alertId}/status`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ status: 'Resolved' }),
                    success: function() {
                        toastr.success("ƒê√£ ƒë√°nh d·∫•u c·∫£nh b√°o ƒë√£ x·ª≠ l√Ω");
                        location.reload();
                    },
                    error: function() {
                        toastr.error("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i");
                    }
                });
            }
        }

        function reopenAlert(alertId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü l·∫°i c·∫£nh b√°o n√†y?")) {
                $.ajax({
                    url: `/api/alerts/${alertId}/status`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ status: 'New' }),
                    success: function() {
                        toastr.success("ƒê√£ m·ªü l·∫°i c·∫£nh b√°o");
                        location.reload();
                    },
                    error: function() {
                        toastr.error("C√≥ l·ªói x·∫£y ra khi m·ªü l·∫°i c·∫£nh b√°o");
                    }
                });
            }
        }

        function resolveAlert(alertId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√°nh d·∫•u c·∫£nh b√°o n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω?")) {
                $.ajax({
                    url: `/api/alerts/${alertId}/status`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ status: 'Resolved' }),
                    success: function() {
                        toastr.success("ƒê√£ ƒë√°nh d·∫•u c·∫£nh b√°o ƒë√£ x·ª≠ l√Ω");
                        location.reload();
                    },
                    error: function() {
                        toastr.error("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i");
                    }
                });
            }
        }

        function reopenAlert(alertId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü l·∫°i c·∫£nh b√°o n√†y?")) {
                $.ajax({
                    url: `/api/alerts/${alertId}/status`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ status: 'New' }),
                    success: function() {
                        toastr.success("ƒê√£ m·ªü l·∫°i c·∫£nh b√°o");
                        location.reload();
                    },
                    error: function() {
                        toastr.error("C√≥ l·ªói x·∫£y ra khi m·ªü l·∫°i c·∫£nh b√°o");
                    }
                });
            }
        }

        function deleteAlert(alertId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c·∫£nh b√°o n√†y?")) {
                $.ajax({
                    url: `/api/alerts/${alertId}`,
                    type: "DELETE",
                    success: function() {
                        toastr.success("ƒê√£ x√≥a c·∫£nh b√°o th√†nh c√¥ng");
                        $(`tr[data-alert-id="${alertId}"]`).fadeOut();
                        updateTabCounts();
                        
                        if (alertHub) {
                            alertHub.invoke("NotifyAlertDelete", alertId);
                        }
                    },
                    error: function() {
                        toastr.error("C√≥ l·ªói x·∫£y ra khi x√≥a c·∫£nh b√°o");
                    }
                });
            }
        }

        function updateAlertStatus() {
            if (!currentAlertId) return;

            const newStatus = $("#alertStatus").val();
            
            $.ajax({
                url: `/api/alerts/${currentAlertId}/status`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify({
                    status: newStatus
                }),
                success: function() {
                    toastr.success("ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng");
                    $("#alertDetailModal").modal("hide");
                    
                    if (alertHub) {
                        alertHub.invoke("NotifyAlertUpdate", currentAlertId, newStatus);
                    }
                },
                error: function() {
                    toastr.error("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i");
                }
            });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN');
        }



        // Auto-refresh every 30 seconds
        setInterval(function() {
            updateTabCounts();
        }, 30000);
    </script>
} 